program test_interpol2d
use m_ops_building 
use m_error
use no_pfunit
implicit none
    real, parameter :: tabx(4) = (/ 1.0/7.0, 1.23, 3.0/10.0, 6.0 /)
    real, parameter :: taby(5) = (/ -1.0, 1.0/9.0, 2.23, 3.0/8.0, 19.0/7.0 /)
    real :: f(4,5)
    integer, parameter :: nx=7, ny=8
    real, parameter :: ref_fxy(7,8) = reshape( (/   2.31761384E+00,   1.17494667E+00,   1.64028502E+00, &
         1.36396420E+00,   1.08764327E+00,   8.11322510E-01,   5.35001576E-01,   1.23644936E+00,   7.81683445E-01, &
         9.65149283E-01,   8.52585614E-01,   7.40021884E-01,   6.27458274E-01,   5.14894545E-01,   1.55284628E-01, &
         3.88420403E-01,   2.90013701E-01,   3.41207147E-01,   3.92400593E-01,   4.43594009E-01,   4.94787484E-01,   1.52409601E+00, &
         1.05616283E+00,   1.18967032E+00,   1.02698708E+00,   8.64304066E-01,   7.01620996E-01,   5.38937867E-01,   3.13521338E+00, &
         1.82884014E+00,   2.24507594E+00,   1.83116794E+00,   1.41725945E+00,   1.00335169E+00,   5.89443445E-01,   4.74633121E+00, &
         2.60151744E+00,   3.30048156E+00,   2.63534856E+00,   1.97021520E+00,   1.30508232E+00,   6.39948964E-01,   6.35744810E+00, &
         3.37419462E+00,   4.35588694E+00,   3.43952894E+00,   2.52317071E+00,   1.60681283E+00,   6.90454423E-01,   7.62532139E+00, &
         4.36648703E+00,   5.26075935E+00,   4.14229107E+00,   3.02382326E+00,   1.90535545E+00,   7.86887228E-01/), &
          (/7,8/) )
    real, parameter :: ref_dfxy(7,8) = reshape( (/   5.56588173E-03,   5.48334122E-02,   9.07092690E-01, &
         7.47399926E-01,   5.18604219E-01,   2.65878499E-01,   2.88915634E-03,   6.24458909E-01,   2.47324467E-01, &
         4.52648580E-01,   3.46397579E-01,   2.36371279E-01,   1.25060022E-01,   1.32016540E-02,   1.21514767E-01, &
         2.65977681E-02,  -1.60190433E-01,  -1.34210557E-01,  -9.31130052E-02,  -4.68942523E-02,   1.49941444E-03,   5.74853003E-01, &
         4.15445030E-01,   6.38169587E-01,   5.01449704E-01,   3.49227905E-01,   1.91713274E-01,   3.19430828E-02,   3.44948292E-01, &
         5.18770337E-01,   1.43709588E+00,   1.17670715E+00,   8.25650632E-01,   4.43010747E-01,   4.67880368E-02,   1.32131577E-03, &
         3.61342907E-01,   2.10117292E+00,   1.77840400E+00,   1.25696707E+00,   6.64106905E-01,   4.00861502E-02,  -3.26967239E-02, &
         8.66398811E-02,   2.65883875E+00,   2.31442261E+00,   1.64606214E+00,   8.56278658E-01,   1.24830008E-02,  -2.39305496E-02, &
         2.94132233E-02,   2.99140835E+00,   2.69313359E+00,   1.94437385E+00,   1.01803017E+00,   1.07712150E-02/), &
          (/7,8/) )

    real :: d_fxy(nx, ny), fxy(nx,ny), x, y
    integer :: ix, iy
    do ix = 1,size(f,1)
       do iy = 1,size(f,2)
          f(ix, iy) = fun(tabx(ix), taby(iy))
       end do
    end do
           
    do ix = 1,nx
       x = tabx(1) + (ix-1+0.01) * (tabx(size(tabx,1))-tabx(1)) / (nx-1+0.02)
       do iy = 1,ny
           y = taby(1) + (iy-1+0.01) * (taby(size(taby,1))-taby(1)) / (ny-1+0.02)
           fxy(ix,iy) = interpol_2d(tabx,taby,f,size(f,1),size(f,2),x,y)
           d_fxy(ix,iy) = fxy(ix,iy) - fun(x,y)
       end do
    end do
    call assertEqual(fxy, ref_fxy, 1e-5, "interpol_2d")
    call assertEqual(d_fxy, ref_dfxy, 1e-5, "interpol_2d")
contains
    real function fun(x,y)
       real, intent(in) :: x, y
       fun = (x*x + 3*y*y) / (1+x*x*2 + y*y/4)
    end function fun
end program test_interpol2d

